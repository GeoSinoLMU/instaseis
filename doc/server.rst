================
Instaseis Server
================

The biggest hurdle to using Instaseis are the generation and storage of the
potentially huge databases. Even if that is possible, concurrent access to a
database on a network storage by multiple users might thrash that storage
system and result in abysmal performance and other problems.

Both issues are potentially resolvable by the Instaseis server. Someone (be
it locally at the institutes network or globally over the internet) opens a
local connection to an Instaseis database and shares data over HTTP.
Instaseis clients can connect to that server with the same interface as to a
local database.

Starting a Server
=================

To launch a server, just execute

.. code-block:: bash

    $ python -m instaseis.server --port 8765 --buffer_size_in_mb 100 /path/to/db

which will launch a webserver and start serving at the specified port. The
``buffer_size_in_mb`` argument is passed to the
:class:`~instaseis.instaseis_db.InstaseisDB` initialization routine. It is
probably a good idea to choose it as big as your machine allows.

Connecting to a Server
======================

Connecting works by simply opening a connection to said machine, e.g. if
the server is running on the same machine:

.. code-block:: python

    >>> import instaseis
    >>> db = instaseis.open_db("http://127.0.0.1:8765")
    >>> print(db)
    RemoteInstaseisDB reciprocal Green's function Database (v7) generated with these parameters:
    components           : vertical and horizontal
    velocity model       : ak135f
    attenuation          : True
    dominant period      : 2.000 s
    dump type            : displ_only
    excitation type      : dipole
    time step            : 0.487 s
    sampling rate        : 2.052 Hz
    number of samples    : 7591
    seismogram length    : 3699.7 s
    source time function : errorf
    source shift         : 3.412 s
    spatial order        : 4
    min/max radius       : 5671.0 - 6371.0 km
    Planet radius        : 6371.0 km
    min/max distance     : 0.0 - 180.0 deg
    time stepping scheme : symplec4
    compiler/user        : ifort         1400 by di29kub on login05
    directory/url        : http://127.0.0.1:8765
    size of netCDF files : 883.0 GB
    generated by AxiSEM version 615a180 at 2014-11-07T18:48:29.000000Z


Usage is then the same as with a local Instaseis database.


Deployment and Performance Considerations
=========================================

Network latency and throughput are the limiting factors of the achievable speed
when using the Instaseis server. The server is based on
`Tornado <http://www.tornadoweb.org/en/stable/>`_ resulting in asynchronous
network I/O. The database access and file I/O on the other hand is, by design,
synchronous. Thus each Instaseis server should easily be able to serve
dozens or more concurrent users with acceptable speed.


.. note::

    If you plan to run this on a machine with outwards facing ports please
    either know what are you doing or ask your network admin to have a look
    to not compromise security of the whole network. Running this on an
    institute's network or some managed server on the other hand should be a
    less of a security issue.


To get a stable server you will have to properly deploy it. A common option
to deploy Tornado apps is to use `supervisor <http://supervisord.org/>`_ for
process management and `ngnix <http://nginx.org/>`_ as a server and reverse
proxy. There are a ton of tutorials online as the configuration differs from
system to system but it should not be hard to find.


Supervisor takes care to start, monitor, and restart the Instaseis server
making sure it runs all the time. A very minimal supervisor configuration
that launches two Instaseis server instances serving two different databases:

.. code-block:: ini

    [program:instaseis_20s]
    command=/path/to/python -m instaseis.server --port=8765 --buffer_size_in_mb=50 /path/to/20s_PREM_ANI_FORCES
    autostart=true
    autorestart=true
    redirect_stderr=true
    stdout_logfile=/tmp/instaseis_20s.log

    [program:instaseis_10s]
    command=/path/to/python -m instaseis.server --port=8766 --buffer_size_in_mb=100 /path/to/10s_PREM_ANI_FORCES
    autostart=true
    autorestart=true
    redirect_stderr=true
    stdout_logfile=/tmp/instaseis_10s.log


Now nginx can be used as a reverse proxy to map the internal routes to nice
URLs. Also make sure to block all ports that you don't need with your
system's firewall. The following example configuration will map both
Instaseis server instances started with supervisor to
``http://site-name.org:8080/20s_PREM_ANI_FORCES`` and
``http://site-name.org:8080/10s_PREM_ANI_FORCES``. One can easily imaging
this being done for a number of models at various frequencies.

.. code-block:: ini

    server {
        listen 8080;
        server_name localhost;
        location /20s_PREM_ANI_FORCES/ {
            rewrite ^/20s_PREM_ANI_FORCES/?(.*)$ /$1 break;
            proxy_pass  http://127.0.0.1:8765;
        }
        location /10s_PREM_ANI_FORCES/ {
            rewrite ^/10s_PREM_ANI_FORCES/?(.*)$ /$1 break;
            proxy_pass  http://127.0.0.1:8766;
        }
    }


Load balancing can also be achieved by a combination of supervisor and nginx.
It might not be worth it as Instaseis itself is oftentimes I/O bound
but it will depend on your specific system and if you face performance
issues it is a potential solution.


REST-like API Documentation
===========================

If you wish to use the Instaseis Server without the Python client this
documentation might be helpful. The Instaseis server offers a REST-like API
with currently three endpoints only supporting GET.

.. contents:: Endpoints
    :local:


GET /
^^^^^

Content-Type
    application/json; charset=UTF-8

Description
    Very basic information about the Instaseis server.

Example Response
    .. code-block:: json

        {
            "type": "Instaseis Remote Server"
            "version": "0.0.1a",
        }


GET /info
^^^^^^^^^

Content-Type
    application/json; charset=UTF-8

Description
    Detailed information about the Instaseis database offered from this
    particular server.

Example Response
    .. code-block:: json

        {
            "attenuation": true,
            "axisem_version": "615a180",
            "compiler": "ifort 1400",
            "components": "vertical and horizontal",
            "datetime": "2014-11-07T18:48:29.000000Z",
            "directory": "",
            "dt": 0.4874457469080638,
            "dump_type": "displ_only",
            "excitation_type": "dipole",
            "filesize": 948145144202,
            "format_version": 7,
            "is_reciprocal": true,
            "length": 3699.713219032204,
            "max_d": 180,
            "max_radius": 6371,
            "min_d": 0,
            "min_radius": 5671,
            "nfft": 16384,
            "npts": 7591
            "period": 2,
            "planet_radius": 6371000,
            "slip": [ "..." ],
            "sliprate": [ "..." ],
            "sampling_rate": 2.05151036057477,
            "source_depth": null,
            "spatial_order": 4,
            "src_shift": 3.4121203422546387,
            "src_shift_samples": 7,
            "stf": "errorf",
            "time_scheme": "symplec4",
            "user": "di29kub on login05",
            "velocity_model": "ak135f",
        }

GET /seismograms_raw
^^^^^^^^^^^^^^^^^^^^

Content-Type
    application/octet-stream

Special Response Headers
    ``Instaseis-Mu``: This transports the mu of the model for the given
    seismogram which is needed for some finite source calculations. Please make
    sure your proxy does not filter it.

Description
    Returns the raw, correctly rotated seismograms from an Instaseis database.
    No further post-processing like STF reconvolution or resampling is
    performed.

Filetype
    Returns MiniSEED files encoded with encoding format 4 (IEEE floating
    point).

+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| Parameter               | Type     | Required | Default Value               | Description                                                          |
+=========================+==========+==========+=============================+======================================================================+
| ``components``          | String   | False    | ZNE                         | The desired seismogram components. Any combination of Z, N, E, R, T. |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``origin_time``         | Datetime | False    | 1970-01-01T00:00:00.000000Z | Time of the first sample.                                            |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| Receiver Parameters                                                                                                                                |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``receiver_latitude``   | Float    | True     |                             | The latitude of the receiver.                                        |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``receiver_longitude``  | Float    | True     |                             | The longitude of the receiver.                                       |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``receiver_depth_in_m`` | Float    | False    | 0.0                         | The depth of the receiver in meter.                                  |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``network_code``        | String   | False    |                             | The network code of the final seismogram.                            |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``station_code``        | String   | False    |                             | The station code of the final seismogram.                            |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| Source Parameters                                                                                                                                  |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``source_latitude``     | Float    | True     |                             | The latitude of the source.                                          |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``source_longitude``    | Float    | True     |                             | The longitude of the source.                                         |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``source_depth_in_m``   | Float    | False    | 0.0                         | The depth of the source in meter.                                    |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| Source can be given as the moment tensor components...                                                                                             |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``m_rr``                | Float    | False    |                             | A moment tensor component in Nm.                                     |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``m_tt``                | Float    | False    |                             | A moment tensor componentin Nm.                                      |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``m_pp``                | Float    | False    |                             | A moment tensor componentin Nm.                                      |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``m_rt``                | Float    | False    |                             | A moment tensor componentin Nm.                                      |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``m_rp``                | Float    | False    |                             | A moment tensor componentin Nm.                                      |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``m_tp``                | Float    | False    |                             | A moment tensor componentin Nm.                                      |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ...as a double couple...                                                                                                                           |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``strike``              | Float    | False    |                             | Strike of a double couple source in degree.                          |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``dip``                 | Float    | False    |                             | Dip of a double couple source in degree.                             |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``rake``                | Float    | False    |                             | Rake of a double couple source in degree.                            |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``M0``                  | Float    | False    |                             | Scalar seismic moment in Nm.                                         |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ...or as a force source.                                                                                                                           |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``f_r``                 | Float    | False    |                             | A force source component in N.                                       |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``f_t``                 | Float    | False    |                             | A force source component in N.                                       |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
| ``f_p``                 | Float    | False    |                             | A force source component in N.                                       |
+-------------------------+----------+----------+-----------------------------+----------------------------------------------------------------------+
